{% extends 'base.html' %}

{% block content %}
<div class="container my-3">
    <div class="d-flex align-items-center">
        <h2>실시간 협업 스프레드시트</h2>
        <span class="ms-3">
            {{ current_date.strftime('%m') }}월 {{ (current_date.day-1)//7+1 }}주차
        </span>
    </div>
    <div id="spreadsheet"></div>
</div>
<!-- Handsontable CSS -->
<link href="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.css" rel="stylesheet">
<!-- Socket.IO -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
<!-- Handsontable JS -->
<script src="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const container = document.getElementById('spreadsheet');
    const socket = io();
    
    // 스프레드시트 초기화
    const hot = new Handsontable(container, {
        data: Array(20).fill().map(() => Array(10).fill('')),
        rowHeaders: true,
        colHeaders: true,
        licenseKey: 'non-commercial-and-evaluation',
        height: 'auto',
        width: 'auto',
        afterChange: function(changes, source) {
            if (source === 'edit') {
                socket.emit('cell_update', {
                    changes: changes,
                    user: '{{ g.user.username }}'
                });
            }
        }
    });

    // 다른 사용자의 변경사항 수신
    socket.on('cell_updated', function(data) {
        if (data.user !== '{{ g.user.username }}') {
            data.changes.forEach(([row, col, oldVal, newVal]) => {
                hot.setDataAtCell(row, col, newVal, 'remote');
            });
        }
    });
});
</script>

<style>
#spreadsheet {
    margin: 20px 0;
    height: 500px;
    overflow: hidden;
}
.handsontable {
    font-size: 14px;
}
</style>
{% endblock %}